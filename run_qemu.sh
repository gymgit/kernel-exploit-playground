#!/bin/bash

if [ -z "$KERNEL_DIR"];then
    KERNEL_DIR=$HOME/dev/pers/kernels/ubuntu-zesty
fi

#TERMINAL="x-terminal-emulator -e"
TERMINAL="tmux split -h"
GDB_FLAGS="-s"
QEMU_FLAGS=""
ARCH=x86_64
GDB=1

function do_help {
    exit 1
}

while [[ $# -gt 1 ]]
do
    key="$1"
    case key in
        -ng|--no-gdb)
        GDB=0
        ;;
        -s|--stop)
        GDB_FLAGS="-s -S"
        ;;
        -q|--qemu-cmd)
        QEMU_FLAGS="$2"
        shift
        ;;
        -h|--help)
        do_help
        ;;
        *)
        echo "Unknown option: $key"
        do_help
        ;;
    esac
    shift
done

if [ "$GDB" -ne "0" ]; then
    CURR_DIR=$PWD
    cd $KERNEL_DIR
    GDB_CMD="gdb -ex \"add-auto-load-safe-path .\" -ex \"file ./vmlinux\" -ex \"set arch i386:x86-64:intel\" -ex \"target remote localhost:1234\" -ex \"c\""
    eval $TERMINAL $GDB_CMD
    cd $CURR_DIR
fi

qemu-system-$ARCH\
    -kernel $KERNEL_DIR/arch/$ARCH/boot/bzImage\
    -initrd ./images/rootfs.cpio.gz\
    -nographic\
    -serial mon:stdio\
    -append 'console=ttyS0 nokaslr'\
    $GDB_FLAGS $QEMU_FLAGS

