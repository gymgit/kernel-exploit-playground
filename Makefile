#TOOLCHAIN=android-ndk-r12b/toolchains/aarch64-linux-android-4.9/prebuilt/linux-x86_64/bin/aarch64-linux-android-
#ARCHI=arm64
CC=gcc
KACCESS_DIR=$(PWD)/../kaccess
KERNEL_DIR=$(PWD)/../kernels/ubuntu-zesty
ROOTFS_DIR=$(PWD)/rootfs
CORES=8
LOCALVERSION=-custom
export

INC=-I$(KACCESS_DIR)/include -I./common/include
CFLAGS=-std=gnu11 -fPIC -static $(INC)
LDFLAGS=-lkeystone -lstdc++ -lm
_DEPS=kacmd.h
DEPS=$(KACCESS_DIR)/include/kacmd.h ./common/include/exp_commons.h

all: kaccess exploit0 exploit1 exploit2 exploit3 exploit4 exploit5 exploit6

kernel: 
	cd $(KERNEL_DIR) && $(MAKE) bzImage

kaccess:
	cd $(KACCESS_DIR) && $(MAKE) install

exploit0: common/commons.c exploit0/exploit0.c $(DEPS)
	$(CC) -o $@/$@.elf $(CFLAGS) exploit0/exploit0.c common/commons.c $(LDFLAGS)
	cp exploit0/exploit0.elf rootfs/root/
	cp exploit0/exploit0.elf rootfs/home/user

exploit1: common/commons.c exploit1/exploit1.c $(DEPS)
	$(CC) -o $@/$@.elf $(CFLAGS) exploit1/exploit1.c common/commons.c $(LDFLAGS)
	cp exploit1/exploit1.elf rootfs/root/
	cp exploit1/exploit1.elf rootfs/home/user

exploit2: common/commons.c exploit2/exploit2.c $(DEPS)
	$(CC) -o $@/$@.elf $(CFLAGS) exploit2/exploit2.c common/commons.c $(LDFLAGS)
	cp exploit2/exploit2.elf rootfs/root/
	cp exploit2/exploit2.elf rootfs/home/user

exploit3: common/commons.c exploit3/exploit3.c $(DEPS)
	$(CC) -o $@/$@.elf $(CFLAGS) exploit3/exploit3.c common/commons.c $(LDFLAGS)
	cp exploit3/exploit3.elf rootfs/root/
	cp exploit3/exploit3.elf rootfs/home/user

exploit4: common/commons.c exploit4/exploit4.c $(DEPS)
	$(CC) -o $@/$@.elf $(CFLAGS) exploit4/exploit4.c common/commons.c $(LDFLAGS)
	cp exploit4/exploit4.elf rootfs/root/
	cp exploit4/exploit4.elf rootfs/home/user

exploit5: common/commons.c exploit5/exploit5.c $(DEPS)
	$(CC) -o $@/$@.elf $(CFLAGS) exploit5/exploit5.c common/commons.c $(LDFLAGS)
	cp exploit5/exploit5.elf rootfs/root/
	cp exploit5/exploit5.elf rootfs/home/user

exploit6: common/commons.c exploit6/exploit6.c $(DEPS)
	$(CC) -o $@/$@.elf $(CFLAGS) exploit6/exploit6.c common/commons.c $(LDFLAGS)
	cp exploit6/exploit6.elf rootfs/root/
	cp exploit6/exploit6.elf rootfs/home/user

#test:  test_kmem.c $(DEPS)
#	$(CC) -o $@.elf $(CFLAGS) $<

.PHONY: clean rootfs kernel kaccess exploit0 exploit1 exploit2 exploit3 exploit4 exploit5 exploit6
clean:
	rm -rf ./rootfs/root/*
	rm -rf ./images/*
	rm -r ./exploit*/*.elf

rootfs:
	cd ./buildroot && $(MAKE)
	cp ./buildroot/output/images/rootfs.cpio.gz ./images

install: all
	#cp $(KERNEL_DIR)/arch/x86_64/boot/bzImage ./images
	#cp $(KERNEL_DIR)/vmlinux ./images
	#cp $(KERNEL_DIR)/vmlinux-gdb.py ./images
	cd ./buildroot && $(MAKE)
	cp ./buildroot/output/images/rootfs.cpio.gz ./images
