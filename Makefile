#TOOLCHAIN=android-ndk-r12b/toolchains/aarch64-linux-android-4.9/prebuilt/linux-x86_64/bin/aarch64-linux-android-
#ARCHI=arm64
CC=gcc
KACCESS_DIR=$(PWD)/../kaccess
KERNEL_DIR=$(PWD)/../kernels/ubuntu-zesty
ROOTFS_DIR=$(PWD)/rootfs
CORES=8
LOCALVERSION=-custom
export

INC=-I$(KACCESS_DIR)/include -I./common/include
CFLAGS=-std=c11 -fPIC -static $(INC)
_DEPS=kacmd.h
DEPS=$(KACCESS_DIR)/include/kacmd.h ./common/include/exp_commons.h

all: kaccess exploit0

kernel: 
	cd $(KERNEL_DIR) && $(MAKE) bzImage

kaccess:
	cd $(KACCESS_DIR) && $(MAKE) install

exploit0: common/commons.c exploit0/exploit0.c $(DEPS)
	$(CC) -o $@/$@.elf $(CFLAGS) exploit0/exploit0.c common/commons.c
	cp exploit0/exploit0.elf rootfs/root/

#test:  test_kmem.c $(DEPS)
#	$(CC) -o $@.elf $(CFLAGS) $<

.PHONY: clean rootfs kernel kaccess exploit0
clean:
	rm -rf ./rootfs/root/*
	rm -rf ./images/*
	rm -r ./exploit*/*.elf

rootfs:
	cd ./buildroot && $(MAKE)
	cp ./buildroot/output/images/rootfs.cpio.gz ./images

install: all
	#cp $(KERNEL_DIR)/arch/x86_64/boot/bzImage ./images
	#cp $(KERNEL_DIR)/vmlinux ./images
	#cp $(KERNEL_DIR)/vmlinux-gdb.py ./images
	cd ./buildroot && $(MAKE)
	cp ./buildroot/output/images/rootfs.cpio.gz ./images
