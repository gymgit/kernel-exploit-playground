#define _LARGEFILE64_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <keystone/keystone.h>

//#include "commons.h"

int open_file(const char* fname, unsigned int flag)
{
    int fd = open(fname, flag);
    if (fd<0)
    {
        fprintf(stderr, "[E] Failed to open %s\n", fname);
        exit(1);
    }
    return fd;
}

void write_dev(int fd, const char* data, size_t length, unsigned long long address)
{
    printf("[I] Writing to address: %llx size: %lu\n", address, length);
    lseek64(fd, address, SEEK_SET);
    unsigned written = 0;
    int ret;
    do
    {
        ret = write(fd, &data[written], length-written);
        if (ret < 0)
        {
            fprintf(stderr, "[E] Failed to write file\n");
            exit(1);
        }
        written += ret;
    }
    while (written < length);
}

void read_dev(int fd, char* data, size_t length, unsigned long long address)
{
    printf("[I] Reading from address: %llx size: %lu\n", address, length);
    if (address)
    {
        lseek64(fd, address, SEEK_SET);
    }
    unsigned written = 0;
    int ret;
    do
    {
        ret = read(fd, &data[written], length-written);
        if (ret < 0)
        {
            fprintf(stderr, "[E] Failed to read file\n");
            exit(1);
        }
        written += ret;
    }
    while (written < length && ret != 0);
}
int vmem;
int pmem;
int cmd;
ks_engine* ks = NULL;

unsigned char* assemble(char* code, size_t *length)
{
    unsigned char * encode;
    size_t count;
    if (ks_asm(ks, code, 0, &encode, length, &count) != KS_ERR_OK)
    {

        fprintf(stderr, "[E] Failed to copmpile ASM at %lu, error: %u\n", count, ks_errno(ks));
        exit(1);
    }
    return encode;
}

void init_keystone()
{
    ks_err err;
    // good place to ifdef based on build defines
    err = ks_open(KS_ARCH_X86, KS_MODE_64, &ks);
    if (err != KS_ERR_OK)
    {
        fprintf(stderr, "[E] Failed to init Keystone\n");
        exit(1);
    }
}

void init(){
    vmem = open_file("/dev/ka_kmem", O_RDWR|O_LARGEFILE);
    pmem = open_file("/dev/ka_mem", O_RDWR|O_LARGEFILE);
    cmd = open_file("/dev/ka_cmd", O_RDWR|O_LARGEFILE);
    init_keystone();
}

void fini()
{
   if(ks)
   {
       ks_close(ks);
   }
}
