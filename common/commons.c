#define _LARGEFILE64_SOURCE

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>

#include "commons.h"

int open_file(const char* fname, unsigned int flag)
{
    int fd = open(fname, flag);
    if (fd<0)
    {
        fprintf(stderr, "[E] Failed to open %s\n", fname);
        exit(1);
    }
    return fd;
}

void write_dev(int fd, const char* data, size_t length, unsigned long long address)
{
    printf("[I] Writing to address: %llx size: %lu\n", address, length);
    lseek64(fd, address, SEEK_SET);
    unsigned written = 0;
    int ret;
    do
    {
        ret = write(fd, &data[written], length-written);
        if (ret < 0)
        {
            fprintf(stderr, "[E] Failed to write file\n");
            exit(1);
        }
        written += ret;
    }
    while (written < length);
}

void read_dev(int fd, char* data, size_t length, unsigned long long address)
{
    printf("[I] Reading from address: %llx size: %lu\n", address, length);
    if (address)
    {
        lseek64(fd, address, SEEK_SET);
    }
    unsigned written = 0;
    int ret;
    do
    {
        ret = read(fd, &data[written], length-written);
        if (ret < 0)
        {
            fprintf(stderr, "[E] Failed to read file\n");
            exit(1);
        }
        written += ret;
    }
    while (written < length && ret != 0);
}

void init(){
    vmem = open_file("/dev/ka_kmem", O_RDWR|O_LARGEFILE);
    pmem = open_file("/dev/ka_mem", O_RDWR|O_LARGEFILE);
    cmd = open_file("/dev/ka_cmd", O_RDWR|O_LARGEFILE);
    
}
